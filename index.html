<html>

<head>
<title>bad-attitude</title>
<style>

body {
  font-size: 12pt;
  font-family: Monaco, monospace;
  background-color: #111;
}

h1 {
  font-size: 12pt;
  text-align: center;
  color: #0F2;
}

#container {
  max-width: 800px;
  width: 80%;
  margin-left: auto;
  margin-right: auto;
  padding: 1ex;
}

input {
  width: 98.5%;
  font-family: Monaco, monospace;
  padding: 1ex;
  margin-bottom: 1ex;
  margin-top: 1ex;
}

#box {
  width: 95%;
  height:10em;
  overflow:scroll;
  border: 1px solid black;
  background-color: #eee;
  padding: 1ex;
}

</style>
<script>
// Redirect to HTTPS if we need to
(function() {
  if (window.location.href.match("http:")) {
    window.location.href = window.location.href.replace("http:", "https:");
  }
})();
</script>
</head>

<body>

<h1>bad-attitude</h1>

<div id="container">

<input id="nick" placeholder="your-nick-here" /><br/>

<div id="box"></div>

<input id="message" placeholder="your-chat-here" /><br/>

</div>


<script src=https://cdn.pubnub.com/pubnub.min.js></script>
<script>

function clean(text) {
  return (''+text).replace( /[<>]/g, '' );
}

// The keys in this dictionary are used as IRC-style commands.
// If a message starts with "/key", then commands["key"] will
// be run.
//  Input:  The object received from pubnub
//  Output: The html to be added to the chat window
//
// WARNING: Do not send messages from these callbacks, due to
// the risk of cascades.
var commands = {
  // IRC-style /me command
  "me": function(obj) {
    var action = obj.message.replace(/^\/me[ ]+/, "");
    return "<i>" + obj.nick + " " + action  + "</i>";
  },

  // Forces all peers to reload the page.  This forces clients
  // to load new code.
  "reload": function(obj) {
    window.location.reload();
  },
};

// Same as commands, but applied to outbound commands.
//   Input:  The object about to be sent
//   Output: The object to be sent, or something false if no
//           object should be sent
var localCommands = {
  "flush": function() {
    delete localStorage.history.
    box.innerHTML = "";
    return null;
  }
};


(function(){
var box = PUBNUB.$('box');
var nick = PUBNUB.$('nick');
var message = PUBNUB.$('message');
var channel = 'bad-attitude';

// Sync in from localStorage
if (localStorage.nick && localStorage.nick.length > 0) {
  nick.value = localStorage.nick;
}
if (localStorage.history && localStorage.history.length > 0) {
  box.innerHTML = localStorage.history;
}

PUBNUB.subscribe({
    channel  : channel,
    callback : function(text) {
      try {
        var obj = JSON.parse(text);
        obj.nick = clean(obj.nick);
        obj.message = clean(obj.message);

        // If there's a command, let it produce the message
        var display = "";
        for (cmd in commands) {
          if (obj.message.match("^/"+cmd)) {
            display = commands[cmd](obj);
            break;
          }
        }

        // By default, "nick: message"
        if (display == "") {
          display = '<b>' + obj.nick + '</b>: ' + obj.message;
        }

        box.innerHTML = box.innerHTML + '<br/>' + display;
      } catch (e) {
        console.log("bad message: "+ JSON.stringify(obj));
        console.log("exception: "+ e);
        box.innerHTML = box.innerHTML + '<br/>Bad message';
      }

      localStorage.history = box.innerHTML;

      box.scrollTop = box.scrollHeight - 10;
    }
});

// Sync nick to localStorage
PUBNUB.bind('change', nick, function(e) {
  localStorage.nick = nick.value;
});

// Send messages when "enter" is pressed
PUBNUB.bind('keyup', message, function(e) {
  if ((e.keyCode || e.charCode) === 13) {
    if (nick.value == "") {
      window.alert("Put in a nick, yo!");
      nick.focus();
      return;
    }

    var obj = {
      nick: nick.value,
      message: message.value
    };
    console.log("sending: "+ JSON.stringify(obj));
    for (cmd in localCommands) {
      if (message.value.match("^/"+cmd)) {
        obj = localCommands[cmd](obj);
        break;
      }
    }

    if (!obj) {
      return;
    }

    console.log("sending: "+ JSON.stringify(obj));
    PUBNUB.publish({
      channel: channel,
      message: JSON.stringify(obj),
      x: (message.value = '')
    })


  }
})
})()

</script>
</body>
</html>
